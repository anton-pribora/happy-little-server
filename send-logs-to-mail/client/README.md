# Сборщик логов

Сборщик логов представлят из себя простой скрипт, который проверяет логи по списку и отпрвляет изменения на сервер.
Если данные были успешно отпрвлены, то сборщик запоминает последний размер лога. При следующей проверке сборщик сравнивает
старый размер лога и новый, если они различаются, то считывает новые данные и отпрвляет их на сервер. Если по каким-либо
причинам отправка провалилась, то сборщик не сохраняет изменения размеров логов.

## Установка

```
cd /www
wget https://github.com/anton-pribora/happy-little-server/raw/master/send-logs-to-mail/client/logposter.php
wget https://github.com/anton-pribora/happy-little-server/raw/master/send-logs-to-mail/client/logposter-config.php
```

Отредактировать файл `logposter-config.php`.

## Запуск

Для запуска через консоль:

```
php ./logposter.php
```

Для запуска в автоматическом режиме раз в час:

```
echo '20 * * * * root php /www/logposter.php > /dev/null' > /etc/cron.d/logposter
```

## Настройка

```php
// Файл logposter-config.php

return [
    // Информация о сервере отправки
    [
        'url'     => 'https://my-site/send-logs-to-mail/',      // Адрес сервера обработки данных
        'params'  => ['key' => 'AAAAAAAAAAAAAAAAAAAAAAAAA',],   // Параметры
        'storage' => __DIR__ .'/logposter.json',                // Файл данных об обработанных логах
        'limit'   => 30,                                        // Ограничение на количество строк из одного лога
        'logs'    => [                                          // Список логов для обработки
            '/www/*/logs/php-errors.log',
        ],
    ],
    // Следующий сервер
    [
        // ...
    ]
];
```

## Требования к серверу обработки данных

Сборщик логов ожидает, что сервер обработки данных будет возвращать код `200` на успешную обработку запроса.
Любой другой код будет считаться ошибкой.

Данные передаются через POST-запрос вида:

```php
$_POST['data'];  // Информация из логов
$_POST['key'];   // Данные из массива 'params' конфига
```

В целях безопасности данные рекомендуется передавать по протоколу HTTPS, поскольку в логах могут
содержаться логины, пароли и персональные данные пользователей.