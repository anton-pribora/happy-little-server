# Настройка динамических страниц с ошибками

Переопределить статичные страницы с ошибками в NGINX достаточно просто. А вот как
сделать страницу с ошибкой динамической, особенно, если это серверные ошибки 50x?
Оказывается, это можно сделать с помощью вызова консольного скрипта. Логика очень простая - 
если происходит ошибка, то запускается консольный скрипт, который генерирует html, отсылает письма и
производит другие манипуляции. После этого всё, что вывел скрипт, передаётся клиенту. 

`nginx-extras` поддерживает работу с Lua и Perl, которые могут запускать консольные скрипты
и передавать им параметры, такие как код ошибки и имя хоста. Остальное дело техники.

Создаём сниппет `/etc/nginx/snippets/errors.conf`:

```
fastcgi_intercept_errors on;
error_page 400 401 402 403 404 500 501 502 503 504 505 /custom_error.html;

location = /custom_error.html {
    default_type 'text/html;charset=utf8';
    content_by_lua '
        command = "/www/errors/bin/errorpage.php " .. ngx.var.status .. " " .. ngx.var.host;
        local handle = io.popen(command);
        local result = handle:read("*a");
        handle:close();
        ngx.print(result);
    ';
    internal;
}
```

В конфиге хоста подключаем сниппет:

```
server {
    ...
    include snippets/errors.conf;
    ...
}
```

Добавляем скрипт `/www/errors/bin/errorpage.php`:

```php
#!/usr/bin/env php
<?php

$error = isset($argv[1]) ? $argv[1] : 'unknown';
$host  = isset($argv[2]) ? $argv[2] : 'undefined';

// Обработка ошибки
if ($error >= 500) {
    // Уведомить разработчика, что всё сломалось
    ...
    echo 'У нас всё сломалось, приносим извинения';
} else if ($error == 403) {
    echo 'Доступ запрещён';
} else if ($error == 404) {
    echo 'Страница не найдена';
} else {
    ...
}
...
```

Скрипт должен быть исполняемым и формировать html, желательно, без дополнительных ссылок.
Если на странице используются css или картинки с этого же домена, то встроить их прямо в 
страницу. Ведь не известно, из-за чего возникла ошибка.